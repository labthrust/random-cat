name: Docker Build and Push

on:
  push:
    # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
    branches:
      - main
    # vã‹ã‚‰å§‹ã¾ã‚‹ã‚¿ã‚°ãŒä½œæˆã•ã‚ŒãŸæ™‚ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
    tags:
      - v*
  pull_request:
    # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
    branches:
      - main
  # æ‰‹å‹•ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  workflow_dispatch: {}

env:
  REGISTRY: ghcr.io
  # GitHub ãƒªãƒã‚¸ãƒˆãƒªåã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸åã¨ã—ã¦ä½¿ç”¨
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest

    # GitHub Container Registry ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’è¨­å®š
    permissions:
      contents: write # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹ã€ã‚³ãƒŸãƒƒãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã‚€
      packages: write # GitHub Container Registry ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
      pull-requests: write # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã‚€

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - uses: actions/checkout@v3

      # Docker Buildxã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - uses: docker/setup-buildx-action@v3

      # GitHub Container Registryã«ãƒ­ã‚°ã‚¤ãƒ³
      - uses: docker/login-action@v2
        # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ãªã„ã®ã§ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆç¾åœ¨ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
        # if: github.event_name != 'pull_request'
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      - uses: docker/metadata-action@v5
        # å¾Œç¶šã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«IDã‚’è¨­å®š
        id: meta
        with:
          # ã‚¤ãƒ¡ãƒ¼ã‚¸åã‚’è¨­å®š
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          # ã‚¿ã‚°ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®š
          tags: |
            # ãƒ–ãƒ©ãƒ³ãƒåã‚’ã‚¿ã‚°ã¨ã—ã¦ä½¿ç”¨ï¼ˆä¾‹ï¼šmainï¼‰
            type=ref,event=branch
            # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆç•ªå·ã‚’ã‚¿ã‚°ã¨ã—ã¦ä½¿ç”¨ï¼ˆä¾‹ï¼špr-123ï¼‰
            type=ref,event=pr
            # ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã‚¿ã‚°ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆä¾‹ï¼šv1.2.3ï¼‰
            type=semver,pattern={{version}}
            # ã‚³ãƒŸãƒƒãƒˆã®SHAçŸ­ç¸®ç‰ˆã‚’ã‚¿ã‚°ã¨ã—ã¦ä½¿ç”¨ï¼ˆä¾‹ï¼šsha-a1b2c3dï¼‰
            type=sha
            # ã‚³ãƒŸãƒƒãƒˆã®SHAå®Œå…¨ç‰ˆã‚’ã‚¿ã‚°ã¨ã—ã¦ä½¿ç”¨
            type=sha,format=long
            # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã®ãƒ“ãƒ«ãƒ‰ã‚’'edge'ã‚¿ã‚°ã¨ã—ã¦ä½¿ç”¨
            type=edge
            # ãƒ“ãƒ«ãƒ‰æ—¥æ™‚ã‚’ã‚¿ã‚°ã¨ã—ã¦ä½¿ç”¨ï¼ˆä¾‹ï¼š20240712-123456ï¼‰
            type=raw,value=on-{{date 'YYYYMMDD-HHmmss' tz='Asia/Tokyo'}}

      # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
      - uses: docker/build-push-action@v6
        with:
          # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆtrue ã«è¨­å®šï¼‰
          push: true
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã¯ãƒ—ãƒƒã‚·ãƒ¥ã—ãªã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆç¾åœ¨ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
          # push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}
          # GitHubActionsã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ã¦ãƒ“ãƒ«ãƒ‰ã‚’é«˜é€ŸåŒ–
          cache-from: type=gha
          # ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜
          cache-to: type=gha,mode=max
          # ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å‘ã‘ã«ãƒ“ãƒ«ãƒ‰
          platforms: linux/amd64,linux/arm64

      # ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’ç”Ÿæˆ
      - name: Generate comment content
        id: comment
        run: |
          COMMENT_BODY="**ğŸ³ Docker images built and pushed to GitHub Container Registry**

          <details>
          <summary>ğŸ·ï¸ View image tags and details</summary>

          **Available Image Tags**
          \`\`\`
          ${{ steps.meta.outputs.tags }}
          \`\`\`

          **Tag Explanations**
          - \`pr-X\`: Tag for this pull request
          - \`on-YYYYMMDD-HHMMSS\`: Build timestamp
          - \`sha-XXXXXXX\`: Short commit SHA
          - \`sha-XXXXXXX...\`: Full commit SHA

          **Tips**
          To use these images, pull your desired tag using the \`docker pull\` command with the full image path from the list above.

          </details>"
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ã‚³ãƒŸãƒƒãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
      - uses: peter-evans/commit-comment@v3
        with:
          body: ${{ steps.comment.outputs.body }}

      # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
      - uses: thollander/actions-comment-pull-request@v2
        if: github.event_name == 'pull_request'
        with:
          comment_tag: image_tags
          message: ${{ steps.comment.outputs.body }}
