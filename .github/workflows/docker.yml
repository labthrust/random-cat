name: Docker Build and Push

on:
  push:
    # vã‹ã‚‰å§‹ã¾ã‚‹ã‚¿ã‚°ãŒä½œæˆã•ã‚ŒãŸæ™‚ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ (ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤)
    tags:
      - v*
  pull_request:
    # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤)
    branches:
      - main

env:
  REGISTRY: ghcr.io
  # GitHub ãƒªãƒã‚¸ãƒˆãƒªåã‚’ãã®ã¾ã¾ã‚¤ãƒ¡ãƒ¼ã‚¸åã¨ã—ã¦ä½¿ç”¨ã™ã‚‹è¨­å®š
  IMAGE_NAME: ${{ github.repository }}
  # ç’°å¢ƒå¤‰æ•°ENVIRONMENTã‚’è¨­å®š
  # æ¡ä»¶:
  # 1. ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ãŒ'push'ã§ã‚ã‚‹
  # 2. ã‚¿ã‚°ãŒ'v'ã§å§‹ã¾ã‚‹ï¼ˆrefs/tags/vã§å§‹ã¾ã‚‹refï¼‰
  # 3. ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒãŒ'main'ã§ã‚ã‚‹ï¼ˆrefs/heads/mainã¨ç­‰ã—ã„refï¼‰
  # ã“ã‚Œã‚‰ã®æ¡ä»¶ã‚’ã™ã¹ã¦æº€ãŸã™å ´åˆã¯'production'ã€ãã‚Œä»¥å¤–ã¯'preview'
  ENVIRONMENT: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && github.ref == 'refs/heads/main' && 'production' || 'preview' }}
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§DEPLOYã‚’trueã«è¨­å®š
  DEPLOY: true

jobs:
  build:
    runs-on: ubuntu-latest

    # è¿½åŠ ã§å¿…è¦ã¨ãªã‚‹æ¨©é™
    permissions:
      contents: write # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹ã€ã‚³ãƒŸãƒƒãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã‚€
      packages: write # GitHub Container Registry ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
      pull-requests: write # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãè¾¼ã‚€

    steps:
      # ã‚¿ã‚°ãŒmainãƒ–ãƒ©ãƒ³ãƒã«å¯¾ã™ã‚‹ã‚‚ã®ã‹ã‚’ç¢ºèªã—ã€ã‚‚ã—ãã†ã§ãªã„å ´åˆã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‚ˆã†ã«DEPLOYã‚’falseã«ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—
      - name: Check if tag is on main branch
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          if [[ "${{ github.event.base_ref }}" != "refs/heads/main" ]]; then
            echo "This tag is not on the main branch. Subsequent steps will be skipped."
            echo "DEPLOY=false" >> $GITHUB_ENV
          fi

      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        if: env.DEPLOY == 'true'
        uses: actions/checkout@v4

      # Docker Buildxã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Docker Buildx
        if: env.DEPLOY == 'true'
        uses: docker/setup-buildx-action@v3

      # ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãƒ¼ã«ãƒ­ã‚°ã‚¤ãƒ³
      - name: Login to Container Registry
        if: env.DEPLOY == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
      - name: Extract Docker metadata
        if: env.DEPLOY == 'true'
        uses: docker/metadata-action@v5
        # å¾Œç¶šã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«IDã‚’è¨­å®š
        id: meta
        with:
          # ã‚¤ãƒ¡ãƒ¼ã‚¸åã®è¨­å®š
          # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã§ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãƒ¼ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’åˆ†ã‘ã‚‹è¨­å®šã«ãªã£ã¦ã„ã‚‹
          images: |
            name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-production,enable=${{ env.ENVIRONMENT == 'production' }}
            name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-preview,enable=${{ env.ENVIRONMENT == 'preview' }}
          # ã‚¿ã‚°ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®š
          tags: |
            # ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¿ã‚°ãŒgit pushã•ã‚ŒãŸã¨ãã¯ãã®ã‚¿ã‚°ã«åŸºã¥ãã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°ã‚’ç”Ÿæˆã™ã‚‹ (ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒç”¨)
            type=semver,pattern={{version}}
            # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆã•ã‚ŒãŸã¨ãã€ã¾ãŸã¯ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«è¿½åŠ ã®pushãŒã‚ã£ãŸã¨ãã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆç•ªå·ã‚’ã‚¿ã‚°ã«ä½¿ç”¨ã™ã‚‹ (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒç”¨)
            type=ref,event=pr

      # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
      - name: Build and push Docker images
        if: env.DEPLOY == 'true'
        uses: docker/build-push-action@v6
        with:
          # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆtrue ã«è¨­å®šï¼‰
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}
          # GitHubActionsã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ã¦ãƒ“ãƒ«ãƒ‰ã‚’é«˜é€ŸåŒ–
          cache-from: type=gha
          # ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜
          cache-to: type=gha,mode=max
          # ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å‘ã‘ã«ãƒ“ãƒ«ãƒ‰
          platforms: linux/amd64,linux/arm64

      # ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’ç”Ÿæˆ
      - name: Generate comment content
        if: env.DEPLOY == 'true'
        id: comment
        run: |
          COMMENT_BODY="**ğŸ³ Docker images built and pushed to GitHub Container Registry**

          <details>
          <summary>ğŸ·ï¸ View image tags and details</summary>

          **Available Image Tags**
          \`\`\`
          ${{ steps.meta.outputs.tags }}
          \`\`\`

          **Tag Explanations**
          - \`pr-X\`: Tag for this pull request
          - \`on-YYYYMMDD-HHMMSS\`: Build timestamp
          - \`sha-XXXXXXX\`: Short commit SHA
          - \`sha-XXXXXXX...\`: Full commit SHA

          **Tips**
          To use these images, pull your desired tag using the \`docker pull\` command with the full image path from the list above.

          </details>"
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ã‚³ãƒŸãƒƒãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
      - name: Add comment to commit
        if: env.DEPLOY == 'true'
        uses: peter-evans/commit-comment@v3
        with:
          body: ${{ steps.comment.outputs.body }}

      # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
      - name: Add comment to pull request (if applicable)
        if: env.DEPLOY == 'true' && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          comment_tag: image_tags
          message: ${{ steps.comment.outputs.body }}
